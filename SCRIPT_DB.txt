CREATE DATABASE  project_bar
    CHARACTER SET utf8mb4
    COLLATE utf8mb4_unicode_ci;

USE project_bar;


CREATE TABLE IF NOT EXISTS status(
	id INTEGER AUTO_INCREMENT PRIMARY KEY,
	name VARCHAR(255) NOT NULL
);


CREATE TABLE IF NOT EXISTS rol(
	id INTEGER AUTO_INCREMENT PRIMARY KEY,
	name VARCHAR(255) NOT NULL
);

CREATE TABLE IF NOT EXISTS user(
	id INTEGER AUTO_INCREMENT PRIMARY KEY,
	name VARCHAR(255) NOT NULL,
	email VARCHAR(255) UNIQUE NOT NULL,
	password VARCHAR(255) NOT NULL,
	id_status INTEGER,
	id_rol INTEGER,
	FOREIGN KEY(id_rol) REFERENCES rol(id),
	FOREIGN KEY(id_status) REFERENCES status(id)
);

CREATE TABLE IF NOT EXISTS product(
	id INTEGER AUTO_INCREMENT PRIMARY KEY,
	name_product VARCHAR(255) UNIQUE NOT NULL,
	image VARCHAR(255) NOT NULL,
	price DECIMAL(65, 2) NOT NULL,
	stock INTEGER NOT NULL,	
	id_status INTEGER,
	FOREIGN KEY(id_status) REFERENCES status(id)
);

CREATE TABLE IF NOT EXISTS event(
	id INTEGER AUTO_INCREMENT PRIMARY KEY,
	name_event VARCHAR(255) NOT NULL,
	date DATETIME NOT NULL
);

CREATE TABLE IF NOT EXISTS `table`(
	id INTEGER AUTO_INCREMENT PRIMARY KEY,
	name_table VARCHAR(20)  NOT NULL,
	id_status INTEGER,
	FOREIGN KEY(id_status) REFERENCES status(id)
);


CREATE TABLE IF NOT EXISTS `order`(
	id INTEGER AUTO_INCREMENT PRIMARY KEY,
	type_document VARCHAR(255) NOT NULL,
	num_document INTEGER NOT NULL,
	id_table INTEGER,
	id_status INTEGER,
	FOREIGN KEY(id_table) REFERENCES `table`(id),
	FOREIGN KEY(id_status) REFERENCES status(id)
);

CREATE TABLE IF NOT EXISTS order_product(
	id INTEGER AUTO_INCREMENT PRIMARY KEY,
	id_order INTEGER,
	id_product INTEGER,
	count INTEGER NOT NULL,
	total DECIMAL(65,2)
	FOREIGN KEY(id_order) REFERENCES `order`(id),
	FOREIGN KEY(id_product) REFERENCES product(id)
);


INSERT INTO Rol(name) VALUES ('Admistrator'), ('Employee');
INSERT INTO status(name) VALUES ('Active'), ('Inactive'), ('Paied');








/*Procedures*/


------------------------------------------------------------EVENTS
--INSERT
DELIMITER //
CREATE PROCEDURE insertEvent (
    IN name_event_e VARCHAR(255),
    IN date_e DATETIME 
)
BEGIN 
    SET @maxId = (SELECT COALESCE(MAX(id), 0) FROM `event`);
    SET @sql = CONCAT('ALTER TABLE `event` AUTO_INCREMENT = ', @maxId + 1);
    PREPARE stmt FROM @sql;
    EXECUTE stmt;
    DEALLOCATE PREPARE stmt;
    INSERT INTO `event`(name_event, date) VALUES (name_event_e, date_e);
END //
DELIMITER ;


--------

--SELECT eventid
DELIMITER //
CREATE PROCEDURE selectEventId(
    IN id_e INTEGER
)
BEGIN
    SELECT id, name_event, DATE_FORMAT(date, '%Y-%m-%d %H:%i') AS date
    FROM event WHERE id = id_e;
END //
DELIMITER ;


-------------

--SELECT ACTIVE
DELIMITER //
CREATE PROCEDURE selectEventActive (
)
BEGIN 
	SELECT id, name_event, date from event where date >= now();
END //
DELIMITER ;

--------

--UPDATE
DELIMITER //
CREATE PROCEDURE updateEvent (
    IN id_e INTEGER,
    IN name_event_e VARCHAR(255),
    IN date_e DATETIME
)
BEGIN 
    UPDATE event SET name_event = name_event_e, date = date_e WHERE id = id_e;
END //
DELIMITER ;

---------

--DELETE
DELIMITER //
CREATE PROCEDURE deleteEvent (
    IN id_e INTEGER
)
BEGIN 
    DELETE FROM event WHERE id = id_e;
END //
DELIMITER ;

-------

--SELECT TOP
DELIMITER //
CREATE PROCEDURE selectEventTop()
BEGIN
    SET lc_time_names = 'es_ES';
    SELECT 
    name_event,
    DATE_ADD(date, INTERVAL 1 SECOND) AS date,
    YEAR(date) AS year,
    MONTHNAME(date) AS month,
    DAY(date) AS day,
    CONCAT(HOUR(date), ':', MINUTE(date)) AS hour
FROM `event`
WHERE date >= NOW()
ORDER BY date ASC;
END //
DELIMITER ;


-----------------------------------------------------------PRODUCTS
--SELECT
DELIMITER //
CREATE PROCEDURE selectProduct ()
BEGIN 
	SELECT * FROM product;
END //
DELIMITER ;

--------------

--SELECT productid
DELIMITER //
CREATE PROCEDURE selectProductId(
	IN id_p INTEGER
)
BEGIN
	SELECT * FROM product WHERE id = id_p;
END //
DELIMITER ;

------

--INSERT
DELIMITER //
CREATE PROCEDURE insertProduct (
		IN name_product_p VARCHAR(255),
		IN image_p VARCHAR(255),
		IN price_p DECIMAL(65, 2),
		IN stock_p INTEGER,	
		IN id_status_p INTEGER
)
BEGIN 
	SET @maxId = (SELECT COALESCE(MAX(id),0) FROM product);
	SET @sql = CONCAT('ALTER TABLE product AUTO_INCREMENT = ', @maxId + 1);
	PREPARE stmt FROM @sql;
	EXECUTE stmt;
	DEALLOCATE PREPARE stmt;
	INSERT INTO product(name_product, image, price, stock, id_status) VALUES(name_product_p, image_p, price_p, stock_p, id_status_p);
END //
DELIMITER ;

---------

--UPDATE
DELIMITER //
CREATE PROCEDURE updateProduct(
		IN id_p INTEGER,
		IN name_product_p VARCHAR(255),
		IN image_p VARCHAR(255),
		IN price_p DECIMAL(65, 2),
		IN stock_p INTEGER,	
		IN id_status_p INTEGER
)
BEGIN 
	UPDATE product SET name_product = name_product_p, image = image_p, price = price_p, stock = stock_p, id_status= id_status_p WHERE id = id_p;
END //
DELIMITER ;

---------

--DELETE
DELIMITER //
CREATE PROCEDURE deleteProduct(
		IN id_p INTEGER
)
BEGIN 
	DELETE FROM product WHERE id = id_p;
END //
DELIMITER ;


---------------------------------------------------------------USERS
--SELECT
DELIMITER //
CREATE PROCEDURE selectUser()
BEGIN 
	SELECT user.id, user.name, user.email, status.name AS status, rol.name AS rol from user inner join status on user.id_status = status.id INNER JOIN rol on rol.id = user.id_rol;
END //
DELIMITER ;

------------------

--SELECT userid
DELIMITER //
CREATE PROCEDURE selectUserId(
	IN id_u INTEGER
)
BEGIN
	SELECT * FROM user WHERE id = id_u;
END //
DELIMITER ;

---------------

--SELECT useremail
DELIMITER //
CREATE PROCEDURE selectUserEmail(
	IN email_u VARCHAR(250)
)
BEGIN
	SELECT email, password FROM user WHERE email = email_u;
END //
DELIMITER ;

-------------

--INSERT
DELIMITER //
CREATE PROCEDURE insertUser (
    IN name_u VARCHAR(255),
    IN email_u VARCHAR(255),
    IN password_u VARCHAR(255),    
    IN id_status_u INTEGER,
    IN id_rol_u INTEGER
)
BEGIN 
    SET @maxId = (SELECT COALESCE(MAX(id), 0) FROM user);
    SET @sql = CONCAT('ALTER TABLE user AUTO_INCREMENT = ', @maxId + 1);
    PREPARE stmt FROM @sql;
    EXECUTE stmt;
    DEALLOCATE PREPARE stmt;
    INSERT INTO user(name, email, password, id_status, id_rol) VALUES(name_u, email_u, password_u, id_status_u, id_rol_u);
END //

DELIMITER ;

----------

--UPDATE
DELIMITER //
CREATE PROCEDURE updateUser(
		IN id_u INTEGER,
		IN name_u VARCHAR(255),
		IN email_u VARCHAR(255),
		IN password_u VARCHAR(255),	
		IN id_status_u INTEGER,
		IN id_rol_u INTEGER
)
BEGIN 
	UPDATE user SET name = name_u, email = email_u, password = password_u, id_status = id_status_u, id_rol = id_rol_u WHERE id = id_u;
END //
DELIMITER ;

-----------

--DELETE
DELIMITER //
CREATE PROCEDURE deleteUser (
    IN id_u INTEGER
)
BEGIN 
    DELETE FROM user WHERE id = id_u;
END //
DELIMITER ;


-----------------------------------------------------------TABLES
--SELECT
DELIMITER //
CREATE PROCEDURE selectTable ()
BEGIN 
	SELECT * FROM `table` ;
END //
DELIMITER ;

--------------

--SELECT tableid
DELIMITER //
CREATE PROCEDURE selectTableId(
	IN id_t INTEGER
)
BEGIN
	SELECT * FROM `table` WHERE id = id_t;
END //
DELIMITER ;

------

--INSERT
DELIMITER //
CREATE PROCEDURE insertTable (
		IN name_table_t VARCHAR(20),
		IN id_status_t INTEGER
)
BEGIN 
	SET @maxId = (SELECT COALESCE(MAX(id), 0) FROM `table`);
	SET @sql = CONCAT('ALTER TABLE `table` AUTO_INCREMENT = ', @maxId + 1);
	PREPARE stmt FROM @sql;
	EXECUTE stmt;
	DEALLOCATE PREPARE stmt;
	INSERT INTO `table`(name_table, id_status) VALUES(name_table_t, id_status_t);
END //
DELIMITER ;

---------

--UPDATE
DELIMITER //
CREATE PROCEDURE updateTable(
		IN id_t INTEGER,
		IN name_table_t VARCHAR(20),
		IN id_status_t INTEGER
)
BEGIN 
	UPDATE `table` SET name_table = name_table_t, id_status = id_status_t WHERE id = id_t;
END //
DELIMITER ;

---------

--DELETE
DELIMITER //
CREATE PROCEDURE deleteTable(
		IN id_t INTEGER
)
BEGIN 
	DELETE FROM `table` WHERE id = id_t;
END //
DELIMITER ;


-----------------------------------------------------------STATUS
--SELECT
DELIMITER //
CREATE PROCEDURE selectStatus ()
BEGIN 
	SELECT * FROM `status` ;
END //
DELIMITER ;

--------------

--SELECT statusid
DELIMITER //
CREATE PROCEDURE selectStatusId(
	IN id_s INTEGER
)
BEGIN
	SELECT * FROM `status` WHERE id = id_s;
END //
DELIMITER ;

------

--INSERT
DELIMITER //
CREATE PROCEDURE insertStatus (
		IN name_s VARCHAR(255)
)
BEGIN 
	SET @maxId = (SELECT MAX(id) FROM status);
	SET @sql = CONCAT('ALTER TABLE `status` AUTO_INCREMENT = ', @maxId + 1);
	PREPARE stmt FROM @sql;
	EXECUTE stmt;
	DEALLOCATE PREPARE stmt;
	INSERT INTO `status`(name) VALUES(name_s);
END //
DELIMITER ;

---------

--UPDATE
DELIMITER //
CREATE PROCEDURE updateStatus(
		IN id_s INTEGER,
		IN name_s VARCHAR(255)
)
BEGIN 
	UPDATE `status` SET name = name_s WHERE id = id_s;
END //
DELIMITER ;

---------

--DELETE
DELIMITER //
CREATE PROCEDURE deleteStatus(
		IN id_s INTEGER
)
BEGIN 
	DELETE FROM `status` WHERE id = id_s;
END //
DELIMITER ;


-----------------------------------------------------------ROL
--SELECT
DELIMITER //
CREATE PROCEDURE selectRol ()
BEGIN 
	SELECT * FROM rol ;
END //
DELIMITER ;

--------------

--SELECT rolid
DELIMITER //
CREATE PROCEDURE selectRolId(
	IN id_r INTEGER
)
BEGIN
	SELECT * FROM rol WHERE id = id_r;
END //
DELIMITER ;

------

--INSERT
DELIMITER //
CREATE PROCEDURE insertRol (
		IN name_r VARCHAR(255)
)
BEGIN 
	SET @maxId = (SELECT MAX(id) FROM rol);
	SET @sql = CONCAT('ALTER TABLE rol AUTO_INCREMENT = ', @maxId + 1);
	PREPARE stmt FROM @sql;
	EXECUTE stmt;
	DEALLOCATE PREPARE stmt;
	INSERT INTO rol(name) VALUES(name_r);
END //
DELIMITER ;

---------

--UPDATE
DELIMITER //
CREATE PROCEDURE updateRol(
		IN id_r INTEGER,
		IN name_r VARCHAR(255)
)
BEGIN 
	UPDATE rol SET name = name_r WHERE id = id_r;
END //
DELIMITER ;

---------

--DELETE
DELIMITER //
CREATE PROCEDURE deleteRol(
		IN id_r INTEGER
)
BEGIN 
	DELETE FROM rol WHERE id = id_r;
END //
DELIMITER ;


-----------------------------------------------------------ORDER
--SELECT
DELIMITER //
CREATE PROCEDURE selectOrder ()
BEGIN 
	SELECT * FROM `order`;
END //
DELIMITER ;

--------------

--SELECT productid
DELIMITER //
CREATE PROCEDURE selectOrderId(
	IN id_o INTEGER
)
BEGIN
	SELECT * FROM `order` WHERE id = id_o;
END //
DELIMITER ;


--SELECT productid
DELIMITER //
CREATE PROCEDURE selectOrderNumDocument(
	IN num_document_o INTEGER
)
BEGIN
	SELECT * FROM `order` WHERE num_document = num_document_o AND id_status = 1;
END //
DELIMITER ;

------

--INSERT
DELIMITER //
CREATE PROCEDURE insertOrder (
		IN type_document_o VARCHAR(255),
		IN num_document_o INTEGER,
		IN id_table_o INTEGER,
		IN id_status_o INTEGER
)
BEGIN 
	SET @maxId = (SELECT COALESCE(MAX(id),0) FROM `order`);
	SET @sql = CONCAT('ALTER TABLE `order` AUTO_INCREMENT = ', @maxId + 1);
	PREPARE stmt FROM @sql;
	EXECUTE stmt;
	DEALLOCATE PREPARE stmt;
	INSERT INTO `order`(type_document, num_document, id_table, id_status) VALUES(type_document_o, num_document_o, id_table_o, id_status_o);
END //
DELIMITER ;

---------

--UPDATE
DELIMITER //
CREATE PROCEDURE updateOrder(
		IN id_o INTEGER,
		IN id_status_o INTEGER
)
BEGIN 
	UPDATE `order` SET id_status = id_status_o WHERE id = id_o;
END //
DELIMITER ;

---------

--DELETE
DELIMITER //
CREATE PROCEDURE deleteOrder(
		IN id_o INTEGER
)
BEGIN 
	DELETE FROM `order` WHERE id = id_o;
END //
DELIMITER ;


-----------------------------------------------------------ORDER PRODUCTS
--SELECT
DELIMITER //
CREATE PROCEDURE selectOrderProducts ()
BEGIN 
	SELECT * FROM order_product;
END //
DELIMITER ;

--------------

--SELECT productid
DELIMITER //
CREATE PROCEDURE selectOrderProductId(
	IN id_op INTEGER
)
BEGIN
	SELECT * FROM order_product WHERE id = id_op;
END //
DELIMITER ;

------

--INSERT
DELIMITER //
CREATE PROCEDURE insertOrderProduct (
		IN id_order_op INTEGER,
		IN id_product_op INTEGER,
		IN count_op INTEGER,
		IN total_op DECIMAL(65,2)
)
BEGIN 
	SET @maxId = (SELECT COALESCE(MAX(id),0) FROM order_product);
	SET @sql = CONCAT('ALTER TABLE order_product AUTO_INCREMENT = ', @maxId + 1);
	PREPARE stmt FROM @sql;
	EXECUTE stmt;
	DEALLOCATE PREPARE stmt;
	INSERT INTO order_product(id_order, id_product, count, total) VALUES(id_order_op, id_product_op, count_op, total_op);
END //
DELIMITER ;

---------

--UPDATE
DELIMITER //
CREATE PROCEDURE updateOrderProduct(
		IN id_op INTEGER,
		IN id_order_op INTEGER,
		IN id_product_op INTEGER,
		IN count_op INTEGER,
		IN total_op DECIMAL(65,2)
)
BEGIN 
	UPDATE order_product SET id_order = id_order_op, id_product = id_product_op, count = count_op, total = total_op WHERE id = id_op;
END //
DELIMITER ;

---------

--DELETE
DELIMITER //
CREATE PROCEDURE deleteOrderProduct(
		IN id_op INTEGER
)
BEGIN 
	DELETE FROM order_product WHERE id = id_op;
END //
DELIMITER ;


/*Procedure for update status where stock is 0 or less*/

DELIMITER //
CREATE PROCEDURE updateAllProductStatus()
BEGIN
    UPDATE product
    SET id_status = 2
    WHERE Stock <= 0;
END //

DELIMITER ;
  
CREATE EVENT updateProductStatusEvent
    ON SCHEDULE EVERY 1 HOUR
    DO
        CALL updateAllProductStatus();

SHOW VARIABLES LIKE 'event_scheduler';

SET GLOBAL event_scheduler = ON;




